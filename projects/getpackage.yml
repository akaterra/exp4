type: "project"

id: "getpackage"

title: "GetPackage"
description: "Org"

info:
  contactEmail: admin@getpackage.com

resync:
  intervalSeconds: 300

artifacts:
  argocdApplicationDev:
    type: "argocd:application"
    config:
      integration: "argocdDev"
  argocdApplicationImageTagDev:
    type: "fetchBy"
    dependsOn:
      - argocdApplicationDev
    config:
      "ArgoCD Image tag":
        source: "argocdApplication.status.summary.images"
        filter:
          "...":
            contains:
              param: "ref.streamId"
        pattern: "\\:([\\w\\-\\.]+)$"
        keys:
          - 1
        to: null
        type: "dockerImage"
      "ArgoCD Deploy status":
        source: "argocdApplication.status.resources"
        filter:
          name:
            in:
              coalesce:
                - param: "stream.config.argocdServiceName"
                - param: "ref.streamId"
          kind:
            eq: "StatefulSet"
        pattern: null
        keys:
          - valueMapping:
              OutOfSync:
                level: warning
                value: "out of sync"
              Synced:
                level: success
                value: "synced"
            valuePath: "status"
        to: "link"
        type: "argocd:syncStatus"
  argocdApplication:
    type: "argocd:application"
    config:
      integration: "argocdStg"
  argocdApplicationImageTag:
    type: "fetchBy"
    dependsOn:
      - argocdApplication
    config:
      "ArgoCD Image tag":
        source: "argocdApplication.status.summary.images"
        filter:
          "...":
            contains:
              param: "ref.streamId"
        pattern: "\\:([\\w\\-\\.]+)$"
        keys:
          - 1
        to: null
        type: "dockerImage"
      "ArgoCD Deploy status":
        source: "argocdApplication.status.resources"
        filter:
          name:
            in:
              coalesce:
                - param: "stream.config.argocdServiceName"
                - param: "ref.streamId"
          kind:
            eq: "StatefulSet"
        pattern: null
        keys:
          - valueMapping:
              OutOfSync:
                level: warning
                value: "out of sync"
              Synced:
                level: success
                value: "synced"
            valuePath: "status"
        to: "link"
        type: "argocd:syncStatus"

definitions:
  none: null

integrations:
  argocdDev:
    type: "argocd"
    config:
      applicationName: "dev-namespace-settings"
  argocdStg:
    type: "argocd"
    config:
      applicationName: "stg"
  github:
    type: "github"
    config:
      org: "getpackageltd"
  githubDev:
    type: "github"
    config:
      org: "getpackageltd"
      branch: "develop"
  githubStg:
    type: "github"
    config:
      org: "getpackageltd"
      branch: "v${version.major}.${version.minor}"
  githubHotfix:
    type: "github"
    config:
      org: "getpackageltd"
      branch: "v${version.major}.${version.minor}.${version.patch}-hotfix"
  githubMaster:
    type: "github"
    config:
      org: "getpackageltd"
      branch: "master"
  githubMain:
    type: "github"
    config:
      org: "getpackageltd"
      branch: "main"

storages:
  postgresql:
    type: "sql"
    config:
      url: "postgresql://postgres:postgres@localhost:5432/streamFlow"
  mongodb:
    type: "mongodb"
    config:
      url: "mongodb://localhost:27017/streamflow"
  github:
    type: "github"
    config:
      integration: "github"

versionings:
  release: &versioningRelease
    type: "semver"
    config:
      namespace: "release"
      storage: "github"
      format: "${version.major}.${version.minor} ${version.prerelease}"
  hotfix: &versioningHotfix
    type: "semver"
    config:
      namespace: "hotfix"
      storage: "github"
      format: "${version.major}.${version.minor}.${version.patch}"
  current: &versioningCurrent
    type: "semver"
    config:
      namespace: "current"
      storage: "github"
      format: "${version.major}.${version.minor} ${version.prerelease}"

flows:
  dev:
    title: ""
    targets:
      - dev
    actions:
      test:
        title: "Run tests"
        steps:
          - type: "runAction"
            title: "Run tests"
            config:
              name: "test"

  release:
    title: ""
    targets:
      - stg
    actions:
      release:
        title: "Create release"
        steps:
          - type: "version:release"
            title: "Increase minor version"
            targets:
              - "stg"
          - type: "moveFrom"
            title: "Create release branch"
            targets:
              - "dev"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "stg"
        params:
          releaseName:
            title: "Release name"
            type: "string"
            constraints:
              minLength: 1
              maxLength: 20
              optional: true
      finishRelease:
        title: "Finish release"
        description: "Move release to production and close release"
        steps:
          - type: "moveTo"
            title: ""
            targets:
              - "production"
          - type: "version:override"
            title: ""
            targets:
              - "stg:production"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "stg:production"
          - type: "detach"
            title: ""
            targets:
              - "stg"
      mergeToDev:
        title: "Merge to develop"
        steps:
          - type: "moveTo"
            title: ""
            targets:
              - "dev"
      mergeFromDev:
        title: "Merge latest develop"
        steps:
          - type: "moveFrom"
            title: ""
            targets:
              - "dev"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "stg"
      mergeFromHotfix:
        title: "Merge latest hotfix"
        steps:
          - type: "moveFrom"
            title: ""
            targets:
              - "hotfix"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "stg"
      mergeFromProduction:
        title: "Merge latest production"
        steps:
          - type: "moveFrom"
            title: ""
            targets:
              - "production"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "stg"
      exclude:
        title: "Exclude"
        steps:
          - type: "detach"
            title: ""
            targets:
              - "stg"
      test:
        title: "Run tests"
        steps:
          - type: "runAction"
            title: "Run tests"
            config:
              name: "test"

  hotfix:
    title: ""
    targets:
      - stgHotfix
    actions:
      hotfix:
        title: "Create hotfix"
        steps:
          - type: "version:override"
            title: ""
            targets:
              - "production:stgHotfix"
          - type: "version:patch"
            title: ""
            targets:
              - "stgHotfix"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "stgHotfix"
          - type: "moveFrom"
            title: ""
            targets:
              - "production"
      finishHotfix:
        title: "Finish hotfix"
        steps:
          - type: "moveTo"
            title: ""
            targets:
              - "production"
          - type: "version:override"
            title: ""
            targets:
              - "production"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "production"
          - type: "detach"
            title: ""
            targets:
              - "stgHotfix"
          - type: "bookmark"
            title: ""
            targets:
              - "production"
      mergeToQa:
        title: "Merge to QA"
        steps:
          - type: "moveTo"
            title: ""
            targets:
              - "stg"
      mergeFromProduction:
        title: "Merge latest production"
        steps:
          - type: "moveFrom"
            title: ""
            targets:
              - "production"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "stgHotfix"
      exclude:
        title: "Exclude"
        steps:
          - type: "detach"
            title: ""
            targets:
              - "stgHotfix"
      test:
        title: "Run tests"
        steps:
          - type: "runAction"
            title: "Run tests"
            config:
              name: "test"

  production:
    title: ""
    targets:
      - production
    actions:
      mergeToDevelop:
        title: "Merge to develop"
        steps:
          - type: "moveTo"
            title: ""
            targets:
              - "dev"

targets:
  dev:
    title: "Development"
    streams:
      gp-account-info-processor:
        type: "github"
        title: "AIP"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-alerts-service:
        type: "github"
        title: "Alerts"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-analytics-service:
        type: "github"
        title: "Analytics"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-charge-service:
        type: "github"
        title: "Charge"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-deliveries-crud-service:
        type: "github"
        title: "Deliveries CRUD"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-deliveries-service:
        type: "github"
        title: "Deliveries"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-deliveries-history-service:
        type: "github"
        title: "Deliveries history"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-events-service:
        type: "github"
        title: "Events"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-frontend-client:
        type: "github"
        title: "FE Operator"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-fe-sender:
        type: "github"
        title: "FE Sender"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-fe-tracker:
        type: "github"
        title: "FE Tracker"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-finance-service:
        type: "github"
        title: "Finance"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-finance-calc:
        type: "github"
        title: "Finance calc"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-graphql-gateway:
        type: "github"
        title: "API Gateway"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-links-service:
        type: "github"
        title: "Links"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-locations-service:
        type: "github"
        title: "Locations"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-notifications-service:
        type: "github"
        title: "Notifications"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-offers-service:
        type: "github"
        title: "Offers"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-postil-service:
        type: "github"
        title: "Post IL"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-processing-service:
        type: "github"
        title: "Processing"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-routes-calc-dev:
        type: "github"
        title: "Routes calc"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-uam-service:
        type: "github"
        title: "UAM"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
      gp-webhooks-service:
        type: "github"
        title: "Webhooks"
        config:
          integration: "githubDev"
        artifacts:
          - "argocdApplicationImageTagDev"
    versioning: null

  stg:
    title: "QA"
    streams:
      gp-account-info-processor:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-alerts-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-analytics-service:
        use: "targets.dev.%-1.%"
        config:
          integration: "githubStg"
          argocdServiceName: "gp-analytics-web"
        artifacts:
          - "argocdApplicationImageTag"
      gp-charge-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-deliveries-crud-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-deliveries-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-deliveries-history-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-events-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-frontend-client:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
        tags:
          - fe
          - op
      gp-fe-sender:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
        tags:
          - fe
          - sender
      gp-fe-tracker:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
        tags:
          - fe
          - tracker
      gp-finance-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-finance-calc:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-graphql-gateway:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-links-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-locations-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-notifications-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-offers-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-postil-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-processing-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
          argocdServiceName: "gp-processing-web"
        artifacts:
          - "argocdApplicationImageTag"
      gp-routes-calc-dev:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-uam-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
      gp-webhooks-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubStg"
        artifacts:
          - "argocdApplicationImageTag"
    versioning: "release"

  stgHotfix:
    title: "QA Hotfix"
    streams:
      gp-account-info-processor:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-alerts-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-analytics-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-charge-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-deliveries-crud-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-deliveries-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-deliveries-history-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-events-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-frontend-client:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        tags:
          - fe
          - op
        artifacts:
      gp-fe-sender:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        tags:
          - fe
          - sender
        artifacts:
      gp-fe-tracker:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        tags:
          - fe
          - tracker
        artifacts:
      gp-finance-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-finance-calc:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-graphql-gateway:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-links-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-locations-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-notifications-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-offers-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-postil-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-processing-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
          argocdServiceName: "gp-processing-web"
        artifacts:
      gp-routes-calc-dev:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-uam-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
      gp-webhooks-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubHotfix"
        artifacts:
    versioning: "hotfix"

  production:
    title: "Production"
    streams:
      gp-account-info-processor:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-alerts-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-analytics-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMain"
        artifacts:
      gp-charge-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-deliveries-crud-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-deliveries-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-deliveries-history-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-events-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-frontend-client:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
        tags:
          - fe
          - op
      gp-fe-sender:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
        tags:
          - fe
          - sender
      gp-fe-tracker:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
        tags:
          - fe
          - tracker
      gp-finance-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-finance-calc:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-graphql-gateway:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-links-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMain"
        artifacts:
      gp-locations-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-notifications-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-offers-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-postil-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-processing-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMain"
          argocdServiceName: "gp-processing-web"
        artifacts:
      gp-routes-calc-dev:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-uam-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
      gp-webhooks-service:
        use: "targets.dev.streams.%"
        config:
          integration: "githubMaster"
        artifacts:
    versioning: "current"
