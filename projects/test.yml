type: "project"

id: "test"
description: ""

definitions:
  none: null

integrations:
  github:
    type: "github"
    config:
      org: "getpackageltd"
  githubDev:
    type: "github"
    config:
      org: "getpackageltd"
      branch: "develop"
  githubStg:
    type: "github"
    config:
      org: "getpackageltd"
      branch: "test-v${version.major}.${version.minor}.${version.patch}"
  githubHotfix:
    type: "github"
    config:
      org: "getpackageltd"
      branch: "hotfix-v${version.major}.${version.minor}.${version.patch}"
  githubMaster:
    type: "github"
    config:
      org: "getpackageltd"
      branch: "master"
  githubMain:
    type: "github"
    config:
      org: "getpackageltd"
      branch: "main"

storages:
  github:
    type: "github"
    config:
      integration: "github"

versionings:
  release: &versioningRelease
    type: "semver"
    config:
      namespace: "release"
      storage: "github"
  hotfix: &versioningHotfix
    type: "semver"
    config:
      namespace: "hotfix"
      storage: "github"
  current: &versioningCurrent
    type: "semver"
    config:
      namespace: "current"
      storage: "github"

flows:
  dev:
    title: ""
    targets:
      - dev
    actions:
      test:
        title: "Run tests"
        steps:
          - type: "runAction"
            title: "Run tests"
            config:
              name: "test"

  release:
    title: ""
    targets:
      - stg
    actions:
      release:
        title: "Create release"
        steps:
          - type: "version:release"
            title: "Increase minor version"
            targets:
              - "stg"
          - type: "moveFrom"
            title: "Create release branch"
            targets:
              - "dev"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "stg"
        params:
          releaseName:
            title: "Release name"
            type: "string"
            constraints:
              minLength: 1
              maxLength: 20
              optional: true
      finishRelease:
        title: "Finish release"
        description: "Move release to production and close release"
        steps:
          - type: "moveTo"
            title: ""
            targets:
              - "production"
          - type: "version:override"
            title: ""
            targets:
              - "stg:production"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "stg:production"
          - type: "detach"
            title: ""
            targets:
              - "stg"
      mergeToDev:
        title: "Merge to develop"
        steps:
          - type: "moveTo"
            title: ""
            targets:
              - "dev"
      mergeFromDev:
        title: "Merge latest develop"
        steps:
          - type: "moveFrom"
            title: ""
            targets:
              - "dev"
      exclude:
        title: "Exclude"
        steps:
          - type: "detach"
            title: ""
            targets:
              - "stg"
      test:
        title: "Run tests"
        steps:
          - type: "runAction"
            title: "Run tests"
            config:
              name: "test"

  hotfix:
    title: ""
    targets:
      - stgHotfix
    actions:
      hotfix:
        title: "Create hotfix"
        steps:
          - type: "version:override"
            title: ""
            targets:
              - "production:stgHotfix"
          - type: "version:patch"
            title: ""
            targets:
              - "stgHotfix"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "stgHotfix"
          - type: "moveFrom"
            title: ""
            targets:
              - "production"
      finishHotfix:
        title: "Finish hotfix"
        steps:
          - type: "moveTo"
            title: ""
            targets:
              - "production"
          - type: "version:override"
            title: ""
            targets:
              - "production"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "production"
          - type: "detach"
            title: ""
            targets:
              - "stgHotfix"
      mergeToQa:
        title: "Merge to QA"
        steps:
          - type: "moveTo"
            title: ""
            targets:
              - "stg"
      mergeFromProduction:
        title: "Merge latest production"
        steps:
          - type: "moveFrom"
            title: ""
            targets:
              - "production"
          - type: "streamVersion:override"
            title: ""
            targets:
              - "stgHotfix"
      exclude:
        title: "Exclude"
        steps:
          - type: "detach"
            title: ""
            targets:
              - "stgHotfix"
      test:
        title: "Run tests"
        steps:
          - type: "runAction"
            title: "Run tests"
            config:
              name: "test"

  production:
    title: ""
    targets:
      - production
    actions:
      mergeToDevelop:
        title: "Merge to develop"
        steps:
          - type: "moveTo"
            title: ""
            targets:
              - "dev"

targets:
  dev:
    title: "Development"
    streams:
      gp-deliveries-service:
        type: "github"
        title: "Deliveries"
        config:
          integration: "githubDev"
      gp-deliveries-history-service:
        type: "github"
        title: "Deliveries history"
        config:
          integration: "githubDev"
      gp-routes-calc-dev:
        type: "github"
        title: "Routes calc"
        config:
          integration: "githubDev"
    versioning: null

  stg:
    title: "QA"
    streams:
      gp-deliveries-crud-service:
        type: "github"
        title: "Deliveries CRUD"
        config:
          integration: "githubStg"
      gp-deliveries-service:
        type: "github"
        title: "Deliveries"
        config:
          integration: "githubStg"
      gp-deliveries-history-service:
        type: "github"
        title: "Deliveries history"
        config:
          integration: "githubStg"
      gp-uam-service:
        type: "github"
        title: "UAM"
        config:
          integration: "githubStg"
    versioning: "release"

  stgHotfix:
    title: "QA Hotfix"
    streams:
      gp-analytics-service:
        type: "github"
        title: "Analytics"
        config:
          integration: "githubHotfix"
      gp-deliveries-service:
        type: "github"
        title: "Deliveries"
        config:
          integration: "githubHotfix"
    versioning: "hotfix"

  production:
    title: "Production"
    streams:
      gp-analytics-service:
        type: "github"
        title: "Analytics"
        config:
          integration: "githubMain"
      gp-deliveries-service:
        type: "github"
        title: "Deliveries"
        config:
          integration: "githubMaster"
    versioning: "current"
